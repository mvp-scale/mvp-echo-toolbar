name: Release to Main

# Manually triggered - you choose when to release
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0, v1.0.1, v1.1.0)'
        required: true
        type: string

# Grant write permissions to push to main
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Remove dev-only files
        run: |
          if [ -f .dev-only ]; then
            echo "=== Cleaning dev-only files ==="

            while IFS= read -r pattern || [ -n "$pattern" ]; do
              # Skip comments and empty lines
              [[ "$pattern" =~ ^#.*$ ]] && continue
              [[ -z "${pattern// }" ]] && continue

              echo "Removing: $pattern"
              rm -rf $pattern 2>/dev/null || true
            done < .dev-only

            # Remove .dev-only itself (not needed on main)
            rm -f .dev-only

            echo "=== Cleanup complete ==="
          else
            echo "No .dev-only file found"
          fi

      - name: Replace main with cleaned dev
        run: |
          # Create/reset main branch to current cleaned state
          git checkout -B main
          git add -A
          git commit -m "Release ${{ inputs.version }}"

          # Force push - replaces main entirely
          git push origin main --force

          echo "=== Main branch updated ==="

      - name: Create version tag
        run: |
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

          echo "=== Tagged as ${{ inputs.version }} ==="

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "  Released ${{ inputs.version }} to main"
          echo "========================================"
          echo ""
          echo "View release: https://github.com/${{ github.repository }}/tree/main"
          echo "View tag: https://github.com/${{ github.repository }}/releases/tag/${{ inputs.version }}"
