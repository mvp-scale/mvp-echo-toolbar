name: Release to Main

# Manually triggered - version is read from package.json automatically
on:
  workflow_dispatch:

# Grant write permissions to push to main
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read version from package.json
        id: version
        run: |
          VERSION="v$(node -p "require('./mvp-echo-toolbar/package.json').version")"
          echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Check tag does not already exist
        run: |
          if git rev-parse "${{ steps.version.outputs.tag }}" >/dev/null 2>&1; then
            echo "ERROR: Tag ${{ steps.version.outputs.tag }} already exists."
            echo "Bump the version in package.json on dev before releasing."
            exit 1
          fi

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Remove dev-only files
        run: |
          if [ -f .dev-only ]; then
            echo "=== Cleaning dev-only files ==="

            while IFS= read -r pattern || [ -n "$pattern" ]; do
              # Skip comments and empty lines
              [[ "$pattern" =~ ^#.*$ ]] && continue
              [[ -z "${pattern// }" ]] && continue

              echo "Removing: $pattern"
              rm -rf $pattern 2>/dev/null || true
            done < .dev-only

            # Remove .dev-only itself (not needed on main)
            rm -f .dev-only

            echo "=== Cleanup complete ==="
          else
            echo "No .dev-only file found"
          fi

      - name: Replace main with cleaned dev
        run: |
          # Create/reset main branch to current cleaned state
          git checkout -B main
          git add -A
          git commit -m "Release ${{ steps.version.outputs.tag }}"

          # Force push - replaces main entirely
          git push origin main --force

          echo "=== Main branch updated ==="

      - name: Create version tag
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

          echo "=== Tagged as ${{ steps.version.outputs.tag }} ==="

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "  Released ${{ steps.version.outputs.tag }} to main"
          echo "========================================"
          echo ""
          echo "View release: https://github.com/${{ github.repository }}/tree/main"
          echo "View tag: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
