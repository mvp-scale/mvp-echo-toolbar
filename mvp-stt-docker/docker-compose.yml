# MVP Speech-to-Text Docker Stack
#
# mvp-asr:    sherpa-onnx C++ WebSocket server (GPU, downloads model on first run)
# mvp-bridge: HTTP-to-WebSocket bridge (OpenAI-compatible API)
# mvp-auth:   Auth proxy (CORS + API keys + usage tracking)
#
# Usage:
#   docker compose up -d --build
#
# Test:
#   curl http://localhost:20300/health

services:
  # ── ASR Engine (sherpa-onnx C++ WebSocket server + GPU) ──
  # Downloads model from HuggingFace on first start, then runs WebSocket server
  mvp-asr:
    build:
      context: .
      dockerfile: Dockerfile.asr
    container_name: mvp-asr
    expose:
      - "6006"
    volumes:
      - mvp-models:/models
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MODEL_DIR=/models/sherpa-onnx-nemo-parakeet-tdt-0.6b-v2-int8
      - HF_REPO=csukuangfj/sherpa-onnx-nemo-parakeet-tdt-0.6b-v2-int8
      # - HF_TOKEN=hf_xxxxx  # Optional: only needed for gated/private models
      - WS_PORT=6006
      - NUM_THREADS=4
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    mem_limit: 8g
    memswap_limit: 8g
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ── HTTP Bridge (translates HTTP POST → WebSocket) ──
  mvp-bridge:
    build:
      context: .
      dockerfile: Dockerfile.bridge
    container_name: mvp-bridge
    expose:
      - "8000"
    environment:
      - WS_HOST=mvp-asr
      - WS_PORT=6006
      - LISTEN_PORT=8000
    depends_on:
      - mvp-asr
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ── Auth Proxy (CORS + API keys + usage tracking) ──
  mvp-auth:
    image: python:3.12-slim
    container_name: mvp-auth
    ports:
      - "20300:8080"
    volumes:
      - ./auth-proxy.py:/app/auth-proxy.py:ro
      - ./api-keys.json:/data/api-keys.json
      - ./usage.json:/data/usage.json
    working_dir: /app
    command: python -u auth-proxy.py
    environment:
      - PYTHONUNBUFFERED=1
      - ASR_BACKEND=http://mvp-bridge:8000
      - LISTEN_PORT=8080
      - KEYS_FILE=/data/api-keys.json
      - USAGE_FILE=/data/usage.json
    depends_on:
      - mvp-bridge
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mvp-models:
    driver: local
