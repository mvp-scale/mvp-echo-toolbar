# MVP Speech-to-Text Docker Stack (v3.0 â€” Hexagonal Architecture)
#
# mvp-bridge: HTTP API server with managed WebSocket adapter (model switching)
# mvp-auth:   Auth proxy (CORS + API keys + usage tracking)
#
# Usage:
#   docker compose up -d --build
#
# Test:
#   curl http://localhost:20300/health

services:
  # -- ASR Engine (legacy standalone C++ WebSocket server) --
  # Only needed when using ADAPTER_TYPE=websocket (single-model, no switching).
  # Not started by default. To use: docker compose --profile legacy up -d
  mvp-asr:
    profiles: ["legacy"]
    build:
      context: .
      dockerfile: Dockerfile.asr
    container_name: mvp-asr
    expose:
      - "6006"
    volumes:
      - mvp-models:/models
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MODEL_DIR=/models/sherpa-onnx-nemo-parakeet-tdt-0.6b-v2-int8
      - HF_REPO=csukuangfj/sherpa-onnx-nemo-parakeet-tdt-0.6b-v2-int8
      - WS_PORT=6006
      - NUM_THREADS=4
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    mem_limit: 8g
    memswap_limit: 8g
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -- HTTP Bridge (hexagonal architecture with pluggable adapters) --
  mvp-bridge:
    build:
      context: .
      dockerfile: Dockerfile.bridge
    container_name: mvp-bridge
    expose:
      - "8000"
    volumes:
      - mvp-models:/models
    environment:
      - ADAPTER_TYPE=managed-websocket
      - LISTEN_PORT=8000
      - MODEL_DIR=/models
      - DEFAULT_MODEL=parakeet-tdt-0.6b-v2-int8
      - SHERPA_PROVIDER=cuda
      - SHERPA_NUM_THREADS=4
      - WS_LOCAL_PORT=7100
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # -- Auth Proxy (CORS + API keys + usage tracking) --
  mvp-auth:
    image: python:3.12-slim
    container_name: mvp-auth
    ports:
      - "20300:8080"
    volumes:
      - ./auth-proxy.py:/app/auth-proxy.py:ro
      - ./api-keys.json:/data/api-keys.json
      - ./usage.json:/data/usage.json
    working_dir: /app
    command: python -u auth-proxy.py
    environment:
      - PYTHONUNBUFFERED=1
      - ASR_BACKEND=http://mvp-bridge:8000
      - LISTEN_PORT=8080
      - KEYS_FILE=/data/api-keys.json
      - USAGE_FILE=/data/usage.json
    depends_on:
      - mvp-bridge
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mvp-models:
    driver: local
